# roles/docker/tasks/main.yml
- name: Check if Docker is already installed
  ansible.builtin.command:
    cmd: docker --version
  register: docker_check
  failed_when: false
  changed_when: false

- name: Install Docker if not present
  when: docker_check.rc != 0
  become: true
  block:
    - name: Update cache
      ansible.builtin.apt:
        update_cache: true

    - name: Install required packages
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
      loop:
        - apt-transport-https
        - ca-certificates
        - curl
        - software-properties-common
        - gnupg

    - name: Add Docker GPG key and repo
      ansible.builtin.shell: |
        install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
        chmod a+r /etc/apt/keyrings/docker.asc
        echo \
        "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
        $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | \
        tee /etc/apt/sources.list.d/docker.list > /dev/null

    - name: Update cache again
      ansible.builtin.apt:
        update_cache: true

    - name: Install Docker packages
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

- name: Refresh SSH session to apply group changes
  ansible.builtin.meta: reset_connection

- name: Display Docker status
  ansible.builtin.debug:
    msg: "Docker is {{ 'already installed' if docker_check.rc == 0 else 'newly installed' }}"
