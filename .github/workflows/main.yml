name: Petclinic pipelines
on: 
    workflow_dispatch: 
    # push: 
    #   branches: 
    #     - main
    #     - 'feature/*'
jobs:
    Docker-build-push:
        runs-on: ubuntu-latest
        steps:
        - name: checkout code
          uses: actions/checkout@v5
        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ vars.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Build and push
          uses: docker/build-push-action@v6
          with:
            push: true
            tags: ${{ vars.DOCKERHUB_USERNAME }}/petclinic:${{github.sha}} 

    Deploy:
        runs-on: ubuntu-latest
        needs: Docker-build-push
        steps:
            - name: checkout code
              uses: actions/checkout@v5
              with:
                repository: abdelrahman-shebl/PetClinic-app
                token: ${{ secrets.GH_PAT}}
            
            # - name: Kubectl tool installer
            #   uses: Azure/setup-kubectl@v4.0.1
                                                          # Have you heared about  Marketplace :) 
            # - name: configure Kubeconfig
            #   run: |
            #     mkdir -p $HOME/.kube
            #     echo "${{ secrets.KUBECONFIG_DATA }}" > $HOME/.kube/config

            - name: Update K8s Manifests
              uses: cschleiden/replace-tokens@v1
              with:
                tokenPrefix: '{'
                tokenSuffix: '}'
                files: '["K8s/Deployments/app-deplotment.yml"]'
              env:
                IMAGE: ${{ vars.DOCKERHUB_USERNAME }}/petclinic:${{github.sha}} 

            - uses: stefanzweifel/git-auto-commit-action@v6
              with:

                commit_message: "Update image to ${{ github.sha }}"
